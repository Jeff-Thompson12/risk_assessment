---
title:    "R Package Risk Assessment"
subtitle: "Report for `r params$package`"
author:   "Author (Role): `r params$username` (`r params$user_role `)"
date:     "Report Date: `r format(Sys.time(), '%B %d, %Y')`"
always_allow_html: true
output:
  html_document:
    theme: cerulean
    highlight: pygments
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 3
runtime: shiny
params:
  package: NA
  riskmetric_version: NA
  cwd: NA
  username: NA
  user_role: NA
---


```{r echo=FALSE, include=FALSE, message=FALSE, warning=FALSE}

setwd(params$cwd)

pkg_GenInfo <- db_fun(paste0(
  "SELECT * FROM package WHERE name ='",
  params$package,
  "'"
))

package_id <- db_fun(paste0(
  "SELECT id FROM package WHERE name = ",
  "'", params$package, "';"))

# If package is not found, then log this error.
if(nrow(package_id) == 0)
  loggit("ERROR", paste0("Package with id ", package_id, "was not found while
                         generating an html report."))

# Collect all the metric names and values associated to package_id.
riskmetrics_mm <- db_fun(glue(
"SELECT metric.name, package_metrics.value
FROM metric
INNER JOIN package_metrics ON metric.id = package_metrics.metric_id
WHERE package_metrics.package_id = '{package_id}' AND metric.class = 'maintenance'"))

for(i in 1:nrow(riskmetrics_mm))
  values[[riskmetrics_mm$name[i]]] <- riskmetrics_mm$value[i]

riskmetrics_cum <- db_fun(glue(
  "SELECT * FROM CommunityUsageMetrics WHERE cum_id ='{params$package}'"))

time_since_first_release_info <- riskmetrics_cum$time_since_first_release[1] 
time_since_version_release_info <- riskmetrics_cum$time_since_version_release[1]
no_of_downloads_last_year_info <- riskmetrics_cum$no_of_downloads_last_year[1]

# Get info on the covr_coverage metric.
# metric_id <- db_fun(paste0("SELECT id FROM metric WHERE name = 'covr_coverage';"))
# covr_coverage <- db_fun(
#   paste0("SELECT value FROM package_metrics WHERE ",
#          "package_id = ", package_id,
#          " AND ",
#          "metric_id = ", metric_id,
#          ";"))
# covr_coverage <- covr_coverage$value

# Gather overall comments.
comment_o <- db_fun(glue(
  "SELECT * FROM Comments
  WHERE comm_id = '{params$package}' AND comment_type = 'o'"))

# Gather maintenance metrics comments.
comment_mm <- db_fun(glue(
  "SELECT user_name, user_role, comment, added_on
  FROM Comments
  WHERE comm_id = '{params$package}' AND comment_type = 'mm'"))  

# Gather community usage metrics comments.
comment_cum <- db_fun(glue(
"SELECT user_name, user_role, comment, added_on
FROM Comments WHERE comm_id = '{params$package}' AND comment_type = 'cum'"))

# Gather test metric comments.
comment_tm <- db_fun(glue(
  "SELECT user_name, user_role, comment, added_on
  FROM Comments
  WHERE comm_id = '{params$package}' AND comment_type = 'tm'"))

# Displays comments.
create_comment_box <- function(comment_info){
  HTML(glue(
  "<div class='col-md-12 comments-box'>
    <div class='col-sm-12 comment-border-bottom'>
      <i class='fa fa-user-tie fa-2x d-inline'>
        {comment_info$user_name} ({comment_info$user_role})
        {comment_info$added_on}
      </i>
      <br>
      <p class='comment'> {comment_info$comment} </p>
    </div>
  </div>"
  ))
}
```


_This report was generated using riskmetric version **`r params$riskmetric_version`**.
Metrics were reviewed via the R Packages Risk Assessment Application._


```{r setup, include=FALSE}
library(knitr)
library(shiny)
library(shinyjs)

knitr::opts_chunk$set(echo = F, fig.width = 5.5, fig.height = 3.4)
```

<hr id="main-hr">

## Summary

**Score:** `r pkg_GenInfo$score`

**Overall risk:** `r ifelse(nchar(pkg_GenInfo$decision) != 0, pkg_GenInfo$decision, "Pending")`

**Overall Comments (`r nrow(comment_o)`):** `r if(nrow(comment_o) == 0) "No comments"`
```{r echo=FALSE}
if(nrow(comment_o) != 0) {
  comment_o |>
    map(rev) |>
    create_comment_box()
}
```

<br>

## General Information

**Package:** `r pkg_GenInfo$name`

**Version:** `r pkg_GenInfo$version`

**Title:** `r pkg_GenInfo$title`

**Description:** `r pkg_GenInfo$description`

**Author:** `r pkg_GenInfo$author`

**Maintainer:** `r pkg_GenInfo$maintainer`

**License:** `r pkg_GenInfo$license`

**Published:** `r pkg_GenInfo$published`

## Maintenance Metrics

```{r echo=FALSE, results="asis", warning=FALSE, message=FALSE}
div(
  class = "row mb-3",
  has_vignettes_infobox(values),
  has_website_infobox(values),
  has_news_infobox(values)
)
```

```{r echo=FALSE, results="asis", warning=FALSE, message=FALSE}
div(
  class = "row mb-3",
  news_current_infobox(values),
  has_bug_reports_url_infobox(values),
  bugs_status_infobox(values)
)
```    

```{r echo=FALSE, results="asis", warning=FALSE, message=FALSE}
div(
  class = "row mb-3",
  export_help_infobox(values),
  has_source_control_infobox(values),
  has_maintainer_infobox(values)
)
```

**Comments for Maintenance Metrics (`r nrow(comment_mm)`):** 
`r if(nrow(comment_mm) == 0) "No comments"`

```{r echo=FALSE}
if(nrow(comment_mm) != 0) {
  comment_mm |> 
    map(rev) |>
    create_comment_box()
}
```


## Community Usage Metrics
```{r echo=FALSE}
shinydashboard::infoBox(
  title = "Package Maturity",
  time_since_first_release_info,
  subtitle = ifelse(time_since_first_release_info != "NA",
                    "Months since first release.",
                    "Metric is not applicable for this source of package."),
  icon = shiny::icon("calendar"),
  width = 3,
  fill = TRUE
)

shinydashboard::infoBox(
  title = "Version Maturity",
  time_since_version_release_info,
  subtitle = ifelse(time_since_version_release_info != "NA", 
                    "Months since version release.",
                    "Metric is not applicable for this source of package."),
  icon = shiny::icon("calendar"),
  width = 3,
  fill = TRUE
)

shinydashboard::infoBox(
  title = "Download Count",
  formatC(no_of_downloads_last_year_info, format="f", big.mark=",", digits=0),
  subtitle = ifelse(no_of_downloads_last_year_info != "NA", 
                    "Downloads in Last Year",
                    "Metric is not applicable for this source of package."),
  icon = shiny::icon("signal"),
  width = 3,
  fill = TRUE
)
```

<div style="margin-top: 100px"></div>
```{r echo=FALSE}
p <- num_dwnlds_plot(data = riskmetrics_cum,
                     input_select_pack = params$package)
tagList(p)
```


```{r echo=FALSE}

if (riskmetrics_cum$no_of_downloads_last_year[1] == 0) {
  tags$script(
    HTML(
      "setTimeout(function(){
         var element = document.getElementsByClassName('highcharts-container ')[0].getElementsByClassName('highcharts-subtitle');
        element[0].style.fontSize = '16px';
        var xVal = element[0]['x'].baseVal[0].value;
        element[0]['y'].baseVal[0].value = xVal/2;
      },500)"
    )
  )
}
```



**Comments for Community Usage Metrics (`r nrow(comment_cum)`):** `r if(nrow(comment_cum) == 0) "No comments"`

```{r echo=FALSE}
if(nrow(comment_cum)) {
  comment_cum |> 
    map(rev) |>
    create_comment_box()
}
```

<style>

.comment {
  padding-top: 10px;
}

#main-hr {
  height: 2px;
  border: none;
  color: #3c8dbc;
  background-color: #3c8dbc
}

.user-name-color {
  color: #7f7f7f;
}

.ml-3 {
  margin-left: 1rem!important;
  font-size: 17px;
}

.comment-border-bottom {
  padding: 0px;
}

.fa-user-tie {
  top: 35%;
  left: 0px;
  font-size: 15px;
}

.blue {
  color: steelblue;
  font-size: 30px;
}

.report{
  font-size:14px
  color: steelblue;
}

.heading_report {
  font-size: 23px;
  font-weight: bold;
}

.d-inline {
  display: inline;
}

.info-box-content, .info-box-icon {
  display: inline;
}

.glyphicon-thumbs-up {
  padding: 3px;
}

.glyphicon-thumbs-down {
  padding: 3px;
}

.fa-bar-chart, .fa-calendar {
  padding: 3px;
}

.mb-3 {
  margin-bottom: 1rem;
}

.mb-4 {
  margin-bottom: 1.5rem;
}

.comments-box {
  max-height: 300px;
  overflow-y: auto;
  padding: 15px;
  border: 1px solid rgb(0, 0, 0.125);
  margin-bottom: 2rem;
}

.amcharts-chart-div > a {
  display: none !important;
}

.info-box-number {
  font-weight: bold;
}

.title.toc-ignore {
  text-align: center;
  color: steelblue;
}

.para-header{
  text-align: left;
  text-decoration: none;
  text-underline-position: under;
}

.highcharts-container {
  margin-top: 3rem;
}

.icon-color-grey::before {
  color: grey;
}
</style>

<!--
# </div>
# <div class="blue para-header">Testing Metrics</div>
# 
# <br>
# 
# ```{r echo=FALSE} 
# 
#   bands = data.frame(
#     start = c(0, 40, 80),
#     end = c(40, 80, 100),
#     color = ifelse(covr_coverage != "pkg_metric_error",
#                    c("#ea3838", "#ffac29", "#00CC00"),
#                    c("#808080", "#808080", "#808080")),
#     stringsAsFactors = FALSE
#   )
#   bands2 = data.frame(
#     start = c(0, 40, 80),
#     end = c(40, 80, 100),
#     color = ifelse(covr_coverage != "pkg_metric_error",
#                    c("#ea3838", "#ffac29", "#00CC00"),
#                    c("#808080", "#808080", "#808080")),
#     stringsAsFactors = FALSE
#   )
#   amAngularGauge(
#     x = as.numeric(ifelse(covr_coverage == "NA", 0, covr_coverage)),
#     start = 0,
#     end = 100,
#     bands = bands,
#     secondAxe = TRUE,
#     start2 = 0,
#     end2 = 100,
#     bands2 = bands2
#   )
# ```

# ```{r echo=FALSE}
# 
# if(covr_coverage == "pkg_metric_error"){
#   tags$script(HTML(
#   "
#   setTimeout(function() {
#     var elementCircle = document.getElementsByClassName('ramcharts_base')[0].getElementsByTagName('circle')[0];
#     elementCircle.nextSibling.remove();
#     elementCircle.remove();
#     var element = document.getElementsByClassName('ramcharts_base')[0].getElementsByTagName('svg')[0];
#     var textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
#     textElement.setAttributeNS(null, 'x', element.width.baseVal.value/2);
#     textElement.setAttributeNS(null, 'y', element.height.baseVal.value/2 +20);
#     textElement.setAttributeNS(null,'font-size','20');
#     textElement.setAttributeNS(null,'fill','red');
#     textElement.setAttributeNS(null,'text-anchor','middle');
#     textElement.setAttributeNS(null,'class','gauge-error-text');
#     var txt = document.createTextNode('Metric is not applicable');
#     textElement.appendChild(txt);
#     element.appendChild(textElement);
#     
#     var textElement2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
#     textElement2.setAttributeNS(null, 'x', element.width.baseVal.value/2);
#     textElement2.setAttributeNS(null, 'y', element.height.baseVal.value/2 +50);
#     textElement2.setAttributeNS(null,'font-size','20');
#     textElement2.setAttributeNS(null,'fill','red');
#     textElement2.setAttributeNS(null,'text-anchor','middle');
#     textElement2.setAttributeNS(null,'class','gauge-error-text');
#     var txt2 = document.createTextNode('for this source of package');
#     textElement2.appendChild(txt2);
#     element.appendChild(textElement2);
#     var allEle = element.querySelectorAll('text')
#     for(let i=0; i<allEle.length; i++){
#       if(allEle[i].textContent == 100 && allEle[i+1].textContent == 0){
#           allEle[i+1].textContent = 'NA';
#       }
#     }
#   }, 1000)
#   "
#   ))
# }
# ```
-->
<!-- <br> -->
<!-- <div class="row col-md-12 comments">Comments for Testing Metrics(`r nrow(comment_tm)`):</div> -->

<!-- <div class="col-md-12 comments-box"> -->

<!-- ```{r echo=FALSE} -->
<!--     comment_tm <- data.frame(comment_tm %>% map(rev)) -->
<!--     HTML(paste( -->
<!--       "<div class='col-sm-12 comment-border-bottom'><i class='fa fa-user-tie fa-2x d-inline'></i><h3 class='ml-3 d-inline'><b class='user-name-color'>", -->
<!--       comment_tm$user_name, -->
<!--       "(", -->
<!--       comment_tm$user_role, -->
<!--       ")", -->
<!--       "</b><sub>", -->
<!--       comment_tm$added_on, -->
<!--       "</sub></h3><h4 class='ml-3 lh-4'>", -->
<!--       comment_tm$comment, -->
<!--       "</h4></div>" -->
<!--     )) -->

<!-- ``` -->
<!-- </div> -->
